---
title: "Comparison of the default data-driven and model-based isobaric labels data analyses."
author: "Piotr Prostko"
date: '`r format(Sys.time(), "%B %d, %Y,%H:%M")`'
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    number_sections: true
    theme: flatly
    code_folding: "hide"
editor_options: 
  chunk_output_type: console
---

```{r, setup, include=FALSE}
# default knitr options for all chunks
knitr::opts_chunk$set(
  message=FALSE,
  warning=FALSE,
  fig.width=12,
  fig.height=7
)
```

```{r}
library(caret)
library(lme4)
library(lmerTest)
library(ggplot2)
library(stringi)
library(gridExtra)
library(ggfortify)
library(dendextend)
library(psych)
library(kableExtra)
library(tidyverse)
library(dtplyr)
library(DEqMS)
source('other_functions.R')
source('plotting_functions.R')
```

```{r}
# set load_outputdata=TRUE if you want to skip long computations (normalization and DEA) and just load the previously saved data sets
load_outputdata=FALSE
data.list <- readRDS('input_data.rds')
dat.l <- data.list$dat.l # data in long format
# which proteins were spiked in?
spiked.proteins <- dat.l %>% distinct(Protein) %>% filter(stri_detect(Protein, fixed='ups')) %>% pull %>% as.character
#TEMP -remove!
# tmp=dat.l %>% distinct(Protein) %>% pull %>% as.character
# dat.l <- dat.l %>% filter(Protein %in% c(tmp[sample(1:length(tmp), size=5)], spiked.proteins))
```

```{r}
# specify # of varying component variants and their names
variant.names <- c('data_driven', 'model_based')
n.comp.variants <- length(variant.names)
# pick reference condition for making plots / doing DEA
referenceCondition <- '0.5'
# specify colours corresponding to biological conditions
condition.color <- tribble(
  ~Condition, ~Color,
  "0.125", 'black',
  "0.5", 'blue',
  "0.667", 'green',
  "1", 'red' )
# create data frame with sample info (distinct Run,Channel, Sample, Condition, Color)
sample.info <- get_sample_info(dat.l, condition.color)
channelNames <- remove_factors(unique(sample.info$Channel))
```

# Unit scale component: log2 transformation of reporter ion intensities

```{r}
dat.unit.l <- dat.l %>% mutate(response=log2(Intensity)) %>% select(-Intensity)
```

# data-driven: Normalization medianSweeping (1)

```{r}
# switch to wide format
dat.unit.w <- pivot_wider(data = dat.unit.l, id_cols=-one_of(c('Condition', 'BioReplicate')), names_from=Channel, values_from=response) 
```

```{r}
if (!load_outputdata){
# subtract the spectrum median log2intensity from the observed log2intensities
dat.norm.w <- dat.unit.w
dat.norm.w[,channelNames] <- median_sweep(dat.norm.w[,channelNames], 1, '-') 
}
```

# data-driven: Summarization

```{r}
if (!load_outputdata){
# normalized data
dat.norm.summ.w <- dat.norm.w %>% group_by(Run, Protein, Peptide) %>% summarise_at(.vars = channelNames, .funs = median) %>% summarise_at(.vars = channelNames, .funs = median) %>% ungroup() 
}
```

```{r}
if (!load_outputdata){
# non-normalized data
dat.nonnorm.summ.w <- dat.unit.w %>% group_by(Run, Protein, Peptide) %>% select(Run, Protein, Peptide, channelNames) %>% summarise_at(.vars = channelNames, .funs = median) %>% select(Run, Protein, channelNames) %>% summarise_at(.vars = channelNames, .funs = median) %>% ungroup()
}
```

# data-driven: Normalization (2)

```{r}
if (!load_outputdata){
# medianSweeping: in each channel, subtract median computed across all proteins within the channel
# do the above separately for each MS run
x.split <- split(dat.norm.summ.w, dat.norm.summ.w$Run)  
x.split.norm  <- lapply(x.split, function(y) {
  y[,channelNames] <- sweep(y[,channelNames], 2, apply(y[,channelNames], 2, median) )
  return(y)
})
dat.norm.summ.w <- bind_rows(x.split.norm)
}
```

# model-based: No summarization

# model-based: Normalization LMM

```{r}
if (!load_outputdata){
dat.summ.l <- dat.unit.l
dat.norm.l <- dat.summ.l
LMM1 <- lmer(response ~ Mixture + Mixture:TechRepMixture + Mixture:TechRepMixture:Channel + (1|Protein)  + (1|Mixture:TechRepMixture:Peptide), data=dat.summ.l)
dat.norm.l$response <- residuals(LMM1) + fixef(LMM1)['(Intercept)']
}
```

```{r}
if (!load_outputdata){
# Integration of data-driven and model-based data 
# dat.nonnorm.summ.l and dat.norm.summ.l are list containers for data in long format
# dat.nonnorm.summ.w2 and dat.norm.summ.w2 are list containers for data in completely wide format

dat.nonnorm.summ.l <- emptyList(variant.names)
dat.norm.summ.l <- emptyList(variant.names)
# model_based
dat.nonnorm.summ.l$model_based <- aggFunc(dat.summ.l, 'response', group.vars=c('Mixture', 'TechRepMixture', 'Run', 'Channel', 'Condition', 'BioReplicate', 'Protein', 'Peptide'), 'median') 
dat.nonnorm.summ.l$model_based <- aggFunc(dat.nonnorm.summ.l$model_based, 'response', group.vars=c('Mixture', 'TechRepMixture', 'Run', 'Channel', 'Condition', 'BioReplicate', 'Protein'), 'median')
dat.norm.summ.l$model_based <- aggFunc(dat.norm.l, 'response', group.vars=c('Mixture', 'TechRepMixture', 'Run', 'Channel', 'Condition', 'BioReplicate', 'Protein', 'Peptide'), 'median')
dat.norm.summ.l$model_based <- aggFunc(dat.norm.summ.l$model_based, 'response', group.vars=c('Mixture', 'TechRepMixture', 'Run', 'Channel', 'Condition', 'BioReplicate', 'Protein'), 'median') 
# data_driven
dat.nonnorm.summ.w$Mixture <- unlist(lapply(stri_split(dat.nonnorm.summ.w$Run,fixed='_'), function(x) x[1]))
dat.nonnorm.summ.l$data_driven <- to_long_format(dat.nonnorm.summ.w, sample.info)
dat.norm.summ.w$Mixture <- unlist(lapply(stri_split(dat.norm.summ.w$Run,fixed='_'), function(x) x[1]))
dat.norm.summ.l$data_driven <- to_long_format(dat.norm.summ.w, sample.info)

dat.nonnorm.summ.w2 <- emptyList(variant.names)
dat.norm.summ.w2 <- emptyList(variant.names)
# model_based
dat.nonnorm.summ.w2$model_based <- pivot_wider(data=dat.nonnorm.summ.l$model_based, id_cols=Protein, names_from=Run:Channel, values_from=response, names_sep=':')
dat.norm.summ.w2$model_based <- pivot_wider(data=dat.norm.summ.l$model_based, id_cols=Protein, names_from=Run:Channel, values_from=response, names_sep=':')
# data_driven
dat.nonnorm.summ.w2$data_driven <- dat.nonnorm.summ.w %>% select(-Mixture) %>% pivot_wider(names_from = Run, values_from = all_of(channelNames), names_glue = "{Run}:{.value}") 
dat.norm.summ.w2$data_driven <- dat.norm.summ.w %>% select(-Mixture) %>% pivot_wider(names_from = Run, values_from = all_of(channelNames), names_glue = "{Run}:{.value}") 
}
```

# QC plots

```{r, echo=FALSE}
if (load_outputdata) load('compare_defaults_outdata.rda')
```

## Boxplot

```{r}
par(mfrow=c(1,2))
for (i in 1:n.comp.variants){
  boxplot_ils(dat.nonnorm.summ.l[[variant.names[i]]], paste('Raw', variant.names[i], sep='_'))
  boxplot_ils(dat.norm.summ.l[[variant.names[i]]], paste('Normalized', variant.names[i], sep='_'))}
```

## MA plot

MA plots of two single samples taken from condition 1 and condition 0.125, measured in different MS runs (samples *Mixture2_1:127C* and *Mixture1_2:129N*, respectively).

```{r}
for (i in 1:n.comp.variants){
  p1 <- maplot_ils(dat.nonnorm.summ.w2[[variant.names[i]]], 'Mixture2_1:127C', 'Mixture1_2:129N', scale='log', paste('Raw', variant.names[i], sep='_'), spiked.proteins)
  p2 <- maplot_ils(dat.norm.summ.w2[[variant.names[i]]], 'Mixture2_1:127C', 'Mixture1_2:129N', scale='log', paste('Normalized', variant.names[i], sep='_'), spiked.proteins)
  grid.arrange(p1, p2, ncol=2)}  
```

MA plots of all samples from condition `1` and condition `0.125` (quantification values averaged within condition).

```{r}
channels.num <- sample.info %>% filter(Condition=='1') %>% distinct(Run:Channel) %>% pull
channels.denom <- sample.info %>% filter(Condition=='0.125') %>% distinct(Run:Channel) %>% pull
for (i in 1:n.comp.variants){
  p1 <- maplot_ils(dat.nonnorm.summ.w2[[variant.names[i]]], channels.num, channels.denom, scale='log', paste('Raw', variant.names[i], sep='_'), spiked.proteins)
  p2 <- maplot_ils(dat.norm.summ.w2[[variant.names[i]]], channels.num, channels.denom, scale='log', paste('Normalized', variant.names[i], sep='_'), spiked.proteins)
grid.arrange(p1, p2, ncol=2)}  
```

## PCA plot

### Using all proteins
```{r}
par(mfrow=c(1, 2))
for (i in 1:n.comp.variants){
  pcaplot_ils(dat.nonnorm.summ.w2[[variant.names[i]]] %>% select(-Protein), info=sample.info, paste('Raw', variant.names[i], sep='_'))
  pcaplot_ils(dat.norm.summ.w2[[variant.names[i]]] %>% select(-Protein), info=sample.info, paste('Normalized', variant.names[i], sep='_'))}
```

### Using spiked proteins only

```{r}
par(mfrow=c(1, 2))
for (i in 1:n.comp.variants){
  pcaplot_ils(dat.nonnorm.summ.w2[[variant.names[i]]] %>% filter(Protein %in% spiked.proteins) %>% select(-'Protein'), info=sample.info, paste('Raw', variant.names[i], sep='_'))
  pcaplot_ils(dat.norm.summ.w2[[variant.names[i]]] %>% filter(Protein %in% spiked.proteins) %>% select(-'Protein'), info=sample.info, paste('Normalized', variant.names[i], sep='_'))}
```

## HC (hierarchical clustering) plot:

### Using all proteins

```{r}
par(mfrow=c(1, 2))
for (i in 1:n.comp.variants){
  dendrogram_ils(dat.nonnorm.summ.w2[[variant.names[i]]] %>% select(-Protein), info=sample.info, paste('Raw', variant.names[i], sep='_'))
  dendrogram_ils(dat.norm.summ.w2[[variant.names[i]]] %>% select(-Protein), info=sample.info, paste('Normalized', variant.names[i], sep='_'))}
```

## Run effect p-value plot

Below the histograms of p-values from the linear model explaining the response variable with Run as a covariate.

```{r}
plots <- vector('list', n.comp.variants)
for (i in 1:n.comp.variants){
dat <- list(dat.nonnorm.summ.l[[variant.names[i]]], dat.norm.summ.l[[variant.names[i]]])
names(dat) <- c(paste('Raw', variant.names[i], sep='_'), paste('Normalized', variant.names[i], sep='_'))
plots[[i]] <- run_effect_plot(dat)}
grid.arrange(grobs = plots, nrow=n.comp.variants)
```

# DEA component

## mixed model (intra-protein correlation modeled with 1|Run:Channel)

```{r}
if (!load_outputdata){
dat.dea <- emptyList(variant.names)  
dat.dea$model_based <- lmm_dea(dat=dat.norm.l, mod.formula='response ~ Condition + (1|Run:Channel)', referenceCondition, scale='log') 
# character vectors containing logFC and p-values columns
}
dea.cols <- colnames(dat.dea$model_based)
logFC.cols <- dea.cols[stri_detect_fixed(dea.cols, 'logFC')]
significance.cols <- dea.cols[stri_detect_fixed(dea.cols, 'q.mod')]
n.contrasts <- length(logFC.cols)
```

## LIMMA
```{r}
if (!load_outputdata){
design.matrix <- get_design_matrix(referenceCondition, sample.info)
this_scale <- 'log'
d <- column_to_rownames(as.data.frame(dat.norm.summ.w2$data_driven), 'Protein')
dat.dea$data_driven <- moderated_ttest(dat=d, design.matrix, scale=this_scale)
}
```

```{r, echo=FALSE}
# save output data
if (!load_outputdata){
save(dat.nonnorm.summ.l
     ,dat.norm.summ.l
     ,dat.norm.l
     ,dat.nonnorm.summ.w2
     ,dat.norm.summ.w2
     ,dat.dea, file='compare_defaults_outdata.rda')
}
```

# Results comparison

## Confusion matrix

```{r, results='asis'}
cm <- conf_mat(dat.dea, 'q.mod', 0.05, spiked.proteins) 
print_conf_mat(cm, referenceCondition)
```

## Scatter plot

```{r}
scatterplot_ils(dat.dea, significance.cols, 'q-values', spiked.proteins)
scatterplot_ils(dat.dea, logFC.cols, 'log2FC', spiked.proteins)
```

## Volcano plot

```{r}
for (i in 1:n.contrasts){
volcanoplot_ils(dat.dea, i, spiked.proteins)}
```

## Violin plot

Let's see whether the spiked protein fold changes make sense
```{r}
# plot theoretical value (horizontal lines) and violin per variant
violinplot_ils(lapply(dat.dea, function(x) x[spiked.proteins, logFC.cols]), referenceCondition)
```

# Conclusions

# Session information

```{r}
sessionInfo()
```

